<!DOCTYPE html>
<html lang="es" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estaci√≥n 7: El Forjador - Odisea IA</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #667eea;
            --secondary: #764ba2;
            --success: #4facfe;
            --forge: #e67e22;
            --danger: #e74c3c;
            --dark-bg: #0f0c29;
            --dark-card: #1a1640;
            --light-bg: #f8f9fa;
            --light-card: #ffffff;
            --text-dark: #ffffff;
            --text-light: #2d3436;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            transition: all 0.3s ease;
        }
        body[data-theme="dark"] {
            background: linear-gradient(135deg, var(--dark-bg) 0%, #2d1b69 100%);
            color: var(--text-dark);
        }
        body[data-theme="light"] {
            background: linear-gradient(135deg, #e0e7ff 0%, #fce7f3 100%);
            color: var(--text-light);
        }
        h1, h2, h3 { font-family: 'Orbitron', sans-serif; }
        .nav-bar {
            padding: 1.5rem 0;
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
        }
        body[data-theme="dark"] .nav-bar {
            background: rgba(15, 12, 41, 0.9);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        body[data-theme="light"] .nav-bar {
            background: rgba(248, 249, 250, 0.9);
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }
        .nav-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .back-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            background: var(--primary);
            color: white;
            text-decoration: none;
            border-radius: 10px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .back-btn:hover {
            background: var(--secondary);
            transform: translateX(-5px);
            color: white;
        }
        .theme-toggle {
            background: var(--primary);
            border: none;
            padding: 12px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .theme-toggle:hover { transform: scale(1.1); }
        .theme-toggle i { color: white; font-size: 1.2rem; }
        .main-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 3rem 2rem;
        }
        .station-header {
            text-align: center;
            margin-bottom: 3rem;
            animation: fadeInDown 0.6s ease;
        }
        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .station-icon {
            font-size: 5rem;
            margin-bottom: 1rem;
            display: inline-block;
            animation: iconFloat 3s ease-in-out infinite;
        }
        @keyframes iconFloat {
            0%, 100% { transform: translateY(0) rotate(-5deg); }
            50% { transform: translateY(-10px) rotate(5deg); }
        }
        .station-title {
            font-size: clamp(2rem, 5vw, 3.5rem);
            font-weight: 900;
            background: linear-gradient(135deg, var(--forge), var(--danger));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 1rem;
        }
        .station-subtitle {
            font-size: 1.2rem;
            opacity: 0.8;
            max-width: 900px;
            margin: 0 auto;
        }
        .tools-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 2rem;
            margin: 3rem 0;
        }
        .tool-card {
            padding: 2.5rem;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        body[data-theme="dark"] .tool-card {
            background: var(--dark-card);
            border-color: rgba(255, 255, 255, 0.1);
        }
        body[data-theme="light"] .tool-card {
            background: var(--light-card);
            border-color: rgba(0, 0, 0, 0.1);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        .tool-card:hover {
            transform: translateY(-10px);
            border-color: var(--forge);
            box-shadow: 0 20px 40px rgba(230, 126, 34, 0.3);
        }
        .tool-icon { font-size: 4rem; margin-bottom: 1.5rem; display: block; }
        .tool-title { font-size: 1.8rem; font-weight: 700; margin-bottom: 1rem; }
        .tool-description { opacity: 0.8; margin-bottom: 1.5rem; line-height: 1.6; }
        .tool-features { list-style: none; padding: 0; }
        .tool-features li {
            padding: 0.5rem 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .tool-features li i { color: var(--success); }
        .generator-container {
            padding: 3rem;
            border-radius: 20px;
            margin: 2rem 0;
            display: none;
        }
        .generator-container.active { display: block; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        body[data-theme="dark"] .generator-container {
            background: var(--dark-card);
            border: 2px solid rgba(230, 126, 34, 0.3);
        }
        body[data-theme="light"] .generator-container {
            background: var(--light-card);
            border: 2px solid rgba(230, 126, 34, 0.2);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        .generator-header { text-align: center; margin-bottom: 3rem; }
        .generator-title { font-size: 2.5rem; font-weight: 900; margin-bottom: 0.5rem; }
        .back-to-tools {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            background: transparent;
            color: var(--forge);
            border: 2px solid var(--forge);
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 2rem;
        }
        .back-to-tools:hover { background: var(--forge); color: white; }
        .form-group { margin: 2rem 0; }
        .form-label {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
            display: block;
        }
        .form-input, .form-textarea, .form-select {
            width: 100%;
            padding: 1rem;
            border-radius: 10px;
            border: 2px solid;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        body[data-theme="dark"] .form-input,
        body[data-theme="dark"] .form-textarea,
        body[data-theme="dark"] .form-select {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.1);
            color: var(--text-dark);
        }
        body[data-theme="light"] .form-input,
        body[data-theme="light"] .form-textarea,
        body[data-theme="light"] .form-select {
            background: white;
            border-color: rgba(0, 0, 0, 0.1);
            color: var(--text-light);
        }
        .form-input:focus, .form-textarea:focus, .form-select:focus {
            outline: none;
            border-color: var(--forge);
            box-shadow: 0 0 0 3px rgba(230, 126, 34, 0.2);
        }
        .form-textarea { min-height: 100px; resize: vertical; }
        .criteria-list { list-style: none; padding: 0; margin: 2rem 0; }
        .criteria-item {
            padding: 1.5rem;
            border-radius: 10px;
            margin: 1rem 0;
            position: relative;
        }
        body[data-theme="dark"] .criteria-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        body[data-theme="light"] .criteria-item {
            background: white;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }
        .criteria-item input { width: 100%; margin-bottom: 0.5rem; }
        .remove-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .remove-btn:hover { transform: scale(1.1); }
        .add-criteria-btn {
            padding: 1rem 2rem;
            background: var(--success);
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        .add-criteria-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(74, 172, 254, 0.3);
        }
        .preview-table {
            width: 100%;
            border-collapse: collapse;
            margin: 2rem 0;
            border-radius: 10px;
            overflow: hidden;
        }
        .preview-table th, .preview-table td {
            padding: 1rem;
            text-align: left;
            border: 1px solid;
        }
        body[data-theme="dark"] .preview-table th,
        body[data-theme="dark"] .preview-table td {
            border-color: rgba(255, 255, 255, 0.1);
        }
        body[data-theme="light"] .preview-table th,
        body[data-theme="light"] .preview-table td {
            border-color: rgba(0, 0, 0, 0.1);
        }
        .preview-table th {
            background: linear-gradient(135deg, var(--forge), var(--danger));
            color: white;
            font-weight: 700;
        }
        .preview-table td { font-size: 0.95rem; }
        body[data-theme="dark"] .preview-table tr:nth-child(even) {
            background: rgba(255, 255, 255, 0.03);
        }
        body[data-theme="light"] .preview-table tr:nth-child(even) {
            background: rgba(0, 0, 0, 0.02);
        }
        .button-group {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
            flex-wrap: wrap;
        }
        .btn-action {
            flex: 1;
            min-width: 200px;
            padding: 1rem 2rem;
            border: none;
            border-radius: 10px;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .btn-primary {
            background: linear-gradient(135deg, var(--forge), var(--danger));
            color: white;
        }
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(230, 126, 34, 0.4);
        }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-secondary {
            background: transparent;
            color: var(--forge);
            border: 2px solid var(--forge);
        }
        .btn-secondary:hover { background: var(--forge); color: white; }
        .project-container {
            padding: 3rem;
            border-radius: 20px;
            margin: 3rem 0;
            border: 2px solid var(--forge);
        }
        body[data-theme="dark"] .project-container {
            background: rgba(230, 126, 34, 0.05);
        }
        body[data-theme="light"] .project-container {
            background: rgba(230, 126, 34, 0.05);
        }
        .project-title {
            font-size: 2.5rem;
            font-weight: 900;
            margin-bottom: 1rem;
            text-align: center;
        }
        .checklist { list-style: none; padding: 0; margin: 2rem 0; }
        .checklist li {
            padding: 1rem;
            margin: 0.75rem 0;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: all 0.3s ease;
        }
        body[data-theme="dark"] .checklist li {
            background: rgba(255, 255, 255, 0.05);
        }
        body[data-theme="light"] .checklist li {
            background: rgba(0, 0, 0, 0.03);
        }
        .checklist li input[type="checkbox"] {
            width: 24px;
            height: 24px;
            cursor: pointer;
        }
        .checklist li label {
            flex: 1;
        }
        .checklist li.checked {
            background: rgba(230, 126, 34, 0.2);
            border-left: 4px solid var(--forge);
        }
        .status-chip {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.35rem 0.85rem;
            border-radius: 999px;
            font-size: 0.85rem;
            font-weight: 600;
            background: rgba(230, 126, 34, 0.15);
            color: var(--forge);
            transition: all 0.3s ease;
        }
        .status-chip.completed {
            background: rgba(79, 172, 254, 0.25);
            color: var(--success);
        }
        .mini-note {
            font-size: 0.85rem;
            opacity: 0.75;
            margin-top: 0.35rem;
        }
        .success-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        .success-modal.active { display: flex; }
        .success-content {
            max-width: 600px;
            width: 90%;
            padding: 3rem;
            border-radius: 20px;
            text-align: center;
        }
        body[data-theme="dark"] .success-content {
            background: var(--dark-card);
            border: 2px solid rgba(255, 255, 255, 0.1);
        }
        body[data-theme="light"] .success-content {
            background: var(--light-card);
        }
        .success-icon {
            font-size: 6rem;
            margin-bottom: 1rem;
            animation: bounceIn 0.6s ease;
        }
        @keyframes bounceIn {
            0% { transform: scale(0) rotate(0deg); }
            50% { transform: scale(1.2) rotate(180deg); }
            100% { transform: scale(1) rotate(360deg); }
        }
        .success-title {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
        }
        .badge-earned {
            display: inline-block;
            padding: 0.75rem 1.5rem;
            background: linear-gradient(135deg, var(--forge), var(--danger));
            color: white;
            border-radius: 20px;
            font-weight: 600;
            margin: 1.5rem 0;
        }
        @media (max-width: 968px) {
            .tools-grid { grid-template-columns: 1fr; }
            .button-group { flex-direction: column; }
            .btn-action { min-width: 100%; }
            .preview-table { font-size: 0.85rem; }
            .preview-table th, .preview-table td { padding: 0.75rem 0.5rem; }
        }
    </style>
</head>
<body data-theme="dark">

<nav class="nav-bar">
    <div class="nav-content">
        <a href="../index.html" class="back-btn">
            <i class="bi bi-arrow-left"></i> Volver al Mapa
        </a>
        <button class="theme-toggle" id="themeToggle">
            <i class="bi bi-sun-fill"></i>
        </button>
    </div>
</nav>

<main class="main-content">
    <header class="station-header">
        <div class="station-icon">‚öíÔ∏è</div>
        <h1 class="station-title">El Forjador de Instrumentos</h1>
        <p class="station-subtitle">
            Crea instrumentos de evaluaci√≥n profesionales: r√∫bricas, listas de cotejo y matrices con IA
        </p>
    </header>

    <section id="toolsSelection">
        <h2 style="text-align: center; margin-bottom: 3rem;">üõ†Ô∏è Elige tu Herramienta</h2>
        <div class="tools-grid">
            <div class="tool-card" onclick="showGenerator('rubric')">
                <div class="tool-icon">üìã</div>
                <h3 class="tool-title">Generador de R√∫bricas</h3>
                <p class="tool-description">Crea r√∫bricas anal√≠ticas con 5 niveles de desempe√±o y descriptores detallados</p>
                <ul class="tool-features">
                    <li><i class="bi bi-check-circle-fill"></i> 5 niveles de desempe√±o</li>
                    <li><i class="bi bi-check-circle-fill"></i> Descriptores por criterio</li>
                    <li><i class="bi bi-check-circle-fill"></i> Alineaci√≥n con Bloom</li>
                    <li><i class="bi bi-check-circle-fill"></i> Exportaci√≥n lista</li>
                </ul>
            </div>
            <div class="tool-card" onclick="showGenerator('checklist')">
                <div class="tool-icon">‚úì</div>
                <h3 class="tool-title">Creador de Listas de Cotejo</h3>
                <p class="tool-description">Dise√±a listas de verificaci√≥n para evaluaci√≥n de productos o desempe√±o</p>
                <ul class="tool-features">
                    <li><i class="bi bi-check-circle-fill"></i> √çtems verificables S√ç/NO</li>
                    <li><i class="bi bi-check-circle-fill"></i> Agrupaci√≥n por categor√≠as</li>
                    <li><i class="bi bi-check-circle-fill"></i> Ponderaci√≥n opcional</li>
                    <li><i class="bi bi-check-circle-fill"></i> Formato imprimible</li>
                </ul>
            </div>
            <div class="tool-card" onclick="showGenerator('matrix')">
                <div class="tool-icon">üìä</div>
                <h3 class="tool-title">Constructor de Matrices</h3>
                <p class="tool-description">Construye matrices de evaluaci√≥n cruzando criterios con niveles</p>
                <ul class="tool-features">
                    <li><i class="bi bi-check-circle-fill"></i> Criterios personalizables</li>
                    <li><i class="bi bi-check-circle-fill"></i> Niveles de logro</li>
                    <li><i class="bi bi-check-circle-fill"></i> Vista tabular completa</li>
                    <li><i class="bi bi-check-circle-fill"></i> C√°lculo de puntaje</li>
                </ul>
            </div>
        </div>
    </section>

    <section id="rubricGenerator" class="generator-container">
        <button class="back-to-tools" onclick="backToTools()">
            <i class="bi bi-arrow-left"></i> Volver a herramientas
        </button>
        <div class="generator-header">
            <h2 class="generator-title">üìã Generador de R√∫bricas</h2>
            <p style="opacity: 0.8;">Crea r√∫bricas con 5 niveles de desempe√±o alineadas a Bloom</p>
        </div>
        <div class="form-group">
            <label class="form-label">Competencia o Actividad a Evaluar</label>
            <textarea class="form-textarea" id="rubricCompetencia" placeholder="Ej: Aplicar t√©cnicas de soldadura SMAW en posici√≥n plana"></textarea>
        </div>
        <div class="form-group">
            <label class="form-label">Nivel de Bloom</label>
            <select class="form-select" id="rubricBloom">
                <option value="">-- Selecciona --</option>
                <option value="1">Recordar</option>
                <option value="2">Comprender</option>
                <option value="3">Aplicar</option>
                <option value="4">Analizar</option>
                <option value="5">Evaluar</option>
                <option value="6">Crear</option>
            </select>
        </div>
        <div class="form-group">
            <label class="form-label">Criterios de Evaluaci√≥n</label>
            <p style="opacity: 0.7; font-size: 0.9rem; margin-bottom: 1rem;">Define entre 4-6 criterios que evaluar√°s</p>
            <ul class="criteria-list" id="rubricCriteriaList">
                <li class="criteria-item">
                    <input type="text" class="form-input" placeholder="Ej: Calidad t√©cnica del trabajo" data-criteria="1">
                </li>
            </ul>
            <button class="add-criteria-btn" onclick="addRubricCriteria()">
                <i class="bi bi-plus-circle"></i> Agregar Criterio
            </button>
        </div>
        <div class="button-group">
            <button class="btn-action btn-secondary" onclick="generateRubricAI()">
                <i class="bi bi-magic"></i> Generar con IA
            </button>
            <button class="btn-action btn-primary" onclick="previewRubric()">
                <i class="bi bi-eye"></i> Vista Previa
            </button>
        </div>
        <div id="rubricPreview" style="display: none; margin-top: 3rem;">
            <h3 style="margin-bottom: 2rem;">üìä R√∫brica Generada</h3>
            <div style="overflow-x: auto;">
                <table class="preview-table" id="rubricTable"></table>
            </div>
            <div class="button-group" style="margin-top: 2rem;">
                <button class="btn-action btn-secondary" onclick="copyRubricText()">
                    <i class="bi bi-clipboard"></i> Copiar Texto
                </button>
                <button class="btn-action btn-primary" onclick="exportRubricHTML()">
                    <i class="bi bi-file-earmark-code"></i> Exportar HTML
                </button>
            </div>
        </div>
    </section>

    <section id="checklistGenerator" class="generator-container">
        <button class="back-to-tools" onclick="backToTools()">
            <i class="bi bi-arrow-left"></i> Volver a herramientas
        </button>
        <div class="generator-header">
            <h2 class="generator-title">‚úì Creador de Listas de Cotejo</h2>
            <p style="opacity: 0.8;">Dise√±a listas de verificaci√≥n para evaluar productos o desempe√±o</p>
        </div>
        <div class="form-group">
            <label class="form-label">Actividad o Producto a Evaluar</label>
            <input type="text" class="form-input" id="checklistActividad" placeholder="Ej: Presentaci√≥n de proyecto formativo">
        </div>
        <div class="form-group">
            <label class="form-label">√çtems a Verificar</label>
            <p style="opacity: 0.7; font-size: 0.9rem; margin-bottom: 1rem;">Define entre 8-15 √≠tems verificables</p>
            <ul class="criteria-list" id="checklistItemsList">
                <li class="criteria-item">
                    <input type="text" class="form-input" placeholder="Ej: Presenta introducci√≥n clara del problema" data-item="1">
                </li>
            </ul>
            <button class="add-criteria-btn" onclick="addChecklistItem()">
                <i class="bi bi-plus-circle"></i> Agregar √çtem
            </button>
        </div>
        <div class="button-group">
            <button class="btn-action btn-secondary" onclick="generateChecklistAI()">
                <i class="bi bi-magic"></i> Generar con IA
            </button>
            <button class="btn-action btn-primary" onclick="previewChecklist()">
                <i class="bi bi-eye"></i> Vista Previa
            </button>
        </div>
        <div id="checklistPreview" style="display: none; margin-top: 3rem;">
            <h3 style="margin-bottom: 2rem;">‚úì Lista de Cotejo Generada</h3>
            <div style="overflow-x: auto;">
                <table class="preview-table" id="checklistTable"></table>
            </div>
            <div class="button-group" style="margin-top: 2rem;">
                <button class="btn-action btn-secondary" onclick="copyChecklistText()">
                    <i class="bi bi-clipboard"></i> Copiar Texto
                </button>
                <button class="btn-action btn-primary" onclick="exportChecklistHTML()">
                    <i class="bi bi-file-earmark-code"></i> Exportar HTML
                </button>
            </div>
        </div>
    </section>

    <section id="matrixGenerator" class="generator-container">
        <button class="back-to-tools" onclick="backToTools()">
            <i class="bi bi-arrow-left"></i> Volver a herramientas
        </button>
        <div class="generator-header">
            <h2 class="generator-title">üìä Constructor de Matrices</h2>
            <p style="opacity: 0.8;">Construye matrices cruzando criterios con niveles de desempe√±o</p>
        </div>
        <div class="form-group">
            <label class="form-label">Competencia a Evaluar</label>
            <textarea class="form-textarea" id="matrixCompetencia" placeholder="Ej: An√°lisis de datos con herramientas estad√≠sticas"></textarea>
        </div>
        <div class="form-group">
            <label class="form-label">Criterios de Evaluaci√≥n</label>
            <ul class="criteria-list" id="matrixCriteriaList">
                <li class="criteria-item">
                    <input type="text" class="form-input" placeholder="Ej: Selecci√≥n de t√©cnicas estad√≠sticas" data-criteria="1">
                </li>
            </ul>
            <button class="add-criteria-btn" onclick="addMatrixCriteria()">
                <i class="bi bi-plus-circle"></i> Agregar Criterio
            </button>
        </div>
        <div class="form-group">
            <label class="form-label">Niveles de Desempe√±o</label>
            <p style="opacity: 0.7; font-size: 0.9rem; margin-bottom: 1rem;">Define al menos 3 niveles para valorar el avance</p>
            <ul class="criteria-list" id="matrixLevelsList">
                <li class="criteria-item">
                    <input type="text" class="form-input" placeholder="Ej: Inicial" data-level="1">
                </li>
                <li class="criteria-item">
                    <input type="text" class="form-input" placeholder="Ej: Competente" data-level="2">
                </li>
            </ul>
            <button class="add-criteria-btn" onclick="addMatrixLevel()">
                <i class="bi bi-plus-circle"></i> Agregar Nivel
            </button>
        </div>
        <div class="button-group">
            <button class="btn-action btn-secondary" onclick="generateMatrixAI()">
                <i class="bi bi-magic"></i> Generar con IA
            </button>
            <button class="btn-action btn-primary" onclick="previewMatrix()">
                <i class="bi bi-eye"></i> Vista Previa
            </button>
        </div>
        <div id="matrixPreview" style="display: none; margin-top: 3rem;">
            <h3 style="margin-bottom: 2rem;">üìä Matriz Generada</h3>
            <div style="overflow-x: auto;">
                <table class="preview-table" id="matrixTable"></table>
            </div>
            <div class="button-group" style="margin-top: 2rem;">
                <button class="btn-action btn-secondary" onclick="copyMatrixText()">
                    <i class="bi bi-clipboard"></i> Copiar Texto
                </button>
                <button class="btn-action btn-primary" onclick="exportMatrixHTML()">
                    <i class="bi bi-file-earmark-code"></i> Exportar HTML
                </button>
            </div>
        </div>
    </section>

    <section id="multiExportToolkit" class="project-container">
        <h2 class="project-title">üß∞ Exportaci√≥n M√∫ltiple</h2>
        <p style="text-align: center; max-width: 780px; margin: 0 auto 2rem; opacity: 0.85;">
            Combina tus instrumentos generados y ll√©valos a tu portafolio en un solo paso. Selecciona los que quieras incluir y copia un resumen unificado o descarga un paquete HTML listo para compartir.
        </p>
        <ul class="checklist" style="margin-top: 2rem;">
            <li>
                <input type="checkbox" id="includeRubric" disabled>
                <label for="includeRubric">
                    <strong>R√∫brica Anal√≠tica</strong>
                    <div class="mini-note">Estado: <span class="status-chip" id="rubricStatus">Pendiente</span></div>
                </label>
            </li>
            <li>
                <input type="checkbox" id="includeChecklist" disabled>
                <label for="includeChecklist">
                    <strong>Lista de Cotejo</strong>
                    <div class="mini-note">Estado: <span class="status-chip" id="checklistStatus">Pendiente</span></div>
                </label>
            </li>
            <li>
                <input type="checkbox" id="includeMatrix" disabled>
                <label for="includeMatrix">
                    <strong>Matriz de Evaluaci√≥n</strong>
                    <div class="mini-note">Estado: <span class="status-chip" id="matrixStatus">Pendiente</span></div>
                </label>
            </li>
        </ul>
        <div class="button-group">
            <button class="btn-action btn-secondary" onclick="copyCombinedToolkit()">
                <i class="bi bi-clipboard-check"></i> Copiar Toolkit
            </button>
            <button class="btn-action btn-primary" onclick="exportCombinedHTML()">
                <i class="bi bi-download"></i> Descargar Paquete HTML
            </button>
        </div>
    </section>

    <section id="finalToolkit" class="project-container">
        <h2 class="project-title">üöÄ Proyecto Final: Toolkit del Forjador</h2>
        <p style="text-align: center; max-width: 780px; margin: 0 auto 2rem; opacity: 0.85;">
            Re√∫ne los tres instrumentos dise√±ados en esta estaci√≥n, personal√≠zalos para tu contexto y consol√≠dalos en un toolkit profesional listo para compartir con tu equipo de formaci√≥n.
        </p>
        <ol style="max-width: 780px; margin: 0 auto 2rem; line-height: 1.7;">
            <li>Genera la <strong>r√∫brica</strong>, la <strong>lista de cotejo</strong> y la <strong>matriz</strong> ajustadas a tu programa.</li>
            <li>Usa la <strong>exportaci√≥n m√∫ltiple</strong> para obtener una versi√≥n integrada en texto o HTML.</li>
            <li>Comparte el toolkit con tu equipo o s√∫belo a tu LMS como evidencia.</li>
        </ol>
        <div style="text-align: center; margin-bottom: 2rem;">
            <div class="status-chip" id="toolkitStatus">Pendiente</div>
            <p class="mini-note" id="bundleNotice" style="margin-top: 0.75rem;">Genera los tres instrumentos con IA para habilitar el toolkit.</p>
        </div>
        <div class="button-group">
            <button class="btn-action btn-primary" onclick="finalizeToolkit()">
                <i class="bi bi-trophy"></i> Marcar Toolkit como Completado
            </button>
        </div>
    </section>

    </main>

    <div class="success-modal" id="successModal">
        <div class="success-content">
            <div class="success-icon">üèÖ</div>
            <h2 class="success-title">¬°Toolkit Forjado con √âxito!</h2>
            <div class="badge-earned">
                <i class="bi bi-award-fill"></i> Insignia "Maestro Forjador" desbloqueada
            </div>
            <p style="opacity: 0.8; margin-bottom: 2rem;">Consolidaste tus instrumentos y est√°s listo para llevarlos al aula o al taller.</p>
            <div class="button-group">
                <button class="btn-action btn-primary" onclick="claimRewards()">
                    <i class="bi bi-check-circle"></i> Registrar Progreso
                </button>
                <button class="btn-action btn-secondary" onclick="closeModal()">
                    <i class="bi bi-arrow-counterclockwise"></i> Seguir Creando
                </button>
            </div>
        </div>
    </div>

    <script>
        const themeToggle = document.getElementById('themeToggle');
        const bodyElement = document.body;
        const savedTheme = localStorage.getItem('odisea-theme') || 'dark';
        bodyElement.setAttribute('data-theme', savedTheme);
        updateThemeIcon(savedTheme);

        themeToggle.addEventListener('click', () => {
            const currentTheme = bodyElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            bodyElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('odisea-theme', newTheme);
            updateThemeIcon(newTheme);
        });

        function updateThemeIcon(theme) {
            const icon = themeToggle.querySelector('i');
            if (theme === 'dark') {
                icon.className = 'bi bi-sun-fill';
            } else {
                icon.className = 'bi bi-moon-stars-fill';
            }
        }

        const toolsSelection = document.getElementById('toolsSelection');
        const generators = {
            rubric: document.getElementById('rubricGenerator'),
            checklist: document.getElementById('checklistGenerator'),
            matrix: document.getElementById('matrixGenerator')
        };

        function showGenerator(type) {
            toolsSelection.style.display = 'none';
            Object.values(generators).forEach(section => section.classList.remove('active'));
            const target = generators[type];
            if (target) {
                target.classList.add('active');
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        function backToTools() {
            Object.values(generators).forEach(section => section.classList.remove('active'));
            toolsSelection.style.display = 'block';
            window.scrollTo({ top: toolsSelection.offsetTop - 80, behavior: 'smooth' });
        }

        function enhanceExistingList(listId) {
            const list = document.getElementById(listId);
            if (!list) return;
            list.querySelectorAll('li').forEach(item => {
                if (!item.querySelector('.remove-btn')) {
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.className = 'remove-btn';
                    btn.innerHTML = '&times;';
                    btn.addEventListener('click', () => item.remove());
                    item.appendChild(btn);
                }
            });
        }

        function createListItem(listId, placeholder, value = '') {
            const list = document.getElementById(listId);
            if (!list) return;
            const li = document.createElement('li');
            li.className = 'criteria-item';
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'form-input';
            input.placeholder = placeholder;
            input.value = value;
            li.appendChild(input);

            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'remove-btn';
            removeBtn.innerHTML = '&times;';
            removeBtn.addEventListener('click', () => li.remove());
            li.appendChild(removeBtn);

            list.appendChild(li);
            input.focus();
        }

        enhanceExistingList('rubricCriteriaList');
        enhanceExistingList('checklistItemsList');
        enhanceExistingList('matrixCriteriaList');
        enhanceExistingList('matrixLevelsList');

        function addRubricCriteria() {
            createListItem('rubricCriteriaList', 'Ej: Calidad t√©cnica del trabajo');
        }

        function addChecklistItem() {
            createListItem('checklistItemsList', 'Ej: Presenta conclusiones basadas en evidencia');
        }

        function addMatrixCriteria() {
            createListItem('matrixCriteriaList', 'Ej: Selecci√≥n de t√©cnicas estad√≠sticas');
        }

        function addMatrixLevel() {
            createListItem('matrixLevelsList', 'Ej: Sobresaliente');
        }

        const generatedInstruments = {
            rubric: null,
            checklist: null,
            matrix: null,
            bundleReady: false
        };

        const statusElements = {
            rubric: document.getElementById('rubricStatus'),
            checklist: document.getElementById('checklistStatus'),
            matrix: document.getElementById('matrixStatus')
        };

        const includeCheckboxes = {
            rubric: document.getElementById('includeRubric'),
            checklist: document.getElementById('includeChecklist'),
            matrix: document.getElementById('includeMatrix')
        };

        function updateInstrumentStatus(type, ready) {
            const status = statusElements[type];
            const checkbox = includeCheckboxes[type];
            if (!status || !checkbox) return;
            if (ready) {
                status.textContent = 'Listo';
                status.classList.add('completed');
                checkbox.disabled = false;
                checkbox.checked = true;
            } else {
                status.textContent = 'Pendiente';
                status.classList.remove('completed');
                checkbox.checked = false;
                checkbox.disabled = true;
            }
            markBundleOutdated();
        }

        function markBundleOutdated() {
            generatedInstruments.bundleReady = false;
            updateToolkitReadiness();
        }

        function getRubricLevels() {
            return ['Inicial', 'En desarrollo', 'Competente', 'Avanzado', 'Experto'];
        }

        function getBloomVerbs(level) {
            const sets = {
                '1': ['Reconoce', 'Identifica', 'Describe', 'Clasifica', 'Explica'],
                '2': ['Comprende', 'Interpreta', 'Relaciona', 'Resume', 'Argumenta'],
                '3': ['Aplica', 'Ejecuta', 'Opera', 'Resuelve', 'Optimiza'],
                '4': ['Analiza', 'Diferencia', 'Eval√∫a', 'Integra', 'Sistematiza'],
                '5': ['Valora', 'Justifica', 'Audita', 'Controla', 'Dirige'],
                '6': ['Dise√±a', 'Formula', 'Innova', 'Implementa', 'Lidera']
            };
            return sets[level] || sets['3'];
        }

        function createRubricDescriptor(criterion, index, bloomLevel) {
            const verbs = getBloomVerbs(bloomLevel);
            const nuances = [
                'con acompa√±amiento constante y siguiendo gu√≠as b√°sicas',
                'cumpliendo parcialmente los criterios establecidos',
                'demostrando desempe√±o estable con retroalimentaci√≥n puntual',
                'argumentando sus decisiones con criterios t√©cnicos',
                'aportando mejoras, innovaciones y liderazgo en el proceso'
            ];
            const verb = verbs[Math.min(index, verbs.length - 1)];
            const nuance = nuances[index] || nuances[nuances.length - 1];
            return `${verb} ${criterion.toLowerCase()} ${nuance}.`;
        }

        function collectListValues(listId) {
            const list = document.getElementById(listId);
            if (!list) return [];
            return Array.from(list.querySelectorAll('input'))
                .map(input => input.value.trim())
                .filter(Boolean);
        }

        function generateRubricAI() {
            const bloomLevel = document.getElementById('rubricBloom').value || '3';
            const suggestionsByBloom = {
                '1': ['Memorizaci√≥n de conceptos clave', 'Identificaci√≥n de herramientas b√°sicas', 'Reconocimiento de normas de seguridad', 'Registro de datos esenciales'],
                '2': ['Comprensi√≥n del procedimiento', 'Interpretaci√≥n de instrucciones t√©cnicas', 'Clasificaci√≥n de materiales', 'Explicaci√≥n del prop√≥sito de cada etapa'],
                '3': ['Ejecuci√≥n del proceso completo', 'Calidad del producto final', 'Uso adecuado de recursos', 'Autonom√≠a en la resoluci√≥n de problemas'],
                '4': ['An√°lisis de resultados', 'Control de calidad y ajustes', 'Gesti√≥n del tiempo y recursos', 'Sustentaci√≥n de decisiones tomadas'],
                '5': ['Evaluaci√≥n cr√≠tica del desempe√±o', 'Retroalimentaci√≥n a compa√±eros', 'Aseguramiento de est√°ndares', 'Gesti√≥n de riesgos y contingencias'],
                '6': ['Innovaci√≥n en soluciones', 'Dise√±o de mejoras al proceso', 'Integraci√≥n de tecnolog√≠as emergentes', 'Transferencia de conocimiento al equipo']
            };
            const suggestions = suggestionsByBloom[bloomLevel] || ['Planificaci√≥n del proceso', 'Ejecuci√≥n t√©cnica', 'Control de calidad', 'Comunicaci√≥n de resultados'];
            const list = document.getElementById('rubricCriteriaList');
            list.innerHTML = '';
            suggestions.forEach(text => createListItem('rubricCriteriaList', 'Criterio de evaluaci√≥n', text));
            alert('‚ú® Sugerencias generadas. Ajusta los criterios antes de obtener la vista previa.');
        }

        function buildRubricData() {
            const competencia = document.getElementById('rubricCompetencia').value.trim();
            const bloomLevel = document.getElementById('rubricBloom').value || '3';
            const criteria = collectListValues('rubricCriteriaList');
            if (!competencia) {
                alert('Por favor describe la competencia o actividad a evaluar.');
                return null;
            }
            if (criteria.length < 3) {
                alert('Agrega al menos 3 criterios para la r√∫brica.');
                return null;
            }
            const levels = getRubricLevels();
            const rows = criteria.map(criterion => ({
                name: criterion,
                descriptors: levels.map((_, index) => createRubricDescriptor(criterion, index, bloomLevel))
            }));
            return { competencia, bloomLevel, levels, rows };
        }

        function generateRubricTableHTML(data) {
            const header = '<tr><th>Criterio</th>' + data.levels.map(level => `<th>${level}</th>`).join('') + '</tr>';
            const body = data.rows
                .map(row => {
                    const cells = row.descriptors.map(desc => `<td>${desc}</td>`).join('');
                    return `<tr><td>${row.name}</td>${cells}</tr>`;
                })
                .join('');
            return `<thead>${header}</thead><tbody>${body}</tbody>`;
        }

        function previewRubric() {
            const data = buildRubricData();
            if (!data) return;
            const table = document.getElementById('rubricTable');
            table.innerHTML = generateRubricTableHTML(data);
            document.getElementById('rubricPreview').style.display = 'block';
            generatedInstruments.rubric = data;
            updateInstrumentStatus('rubric', true);
        }

        function buildRubricText(data) {
            let text = `R√öBRICA ANAL√çTICA\nCompetencia: ${data.competencia}\nNiveles: ${data.levels.join(' | ')}`;
            data.rows.forEach(row => {
                text += `\n\n${row.name}`;
                row.descriptors.forEach((desc, index) => {
                    text += `\n- ${data.levels[index]}: ${desc}`;
                });
            });
            return text;
        }

        function buildRubricHTML(data) {
            const tableHTML = generateRubricTableHTML(data);
            const body = [
                '<h1>R√∫brica Anal√≠tica</h1>',
                `<p><strong>Competencia:</strong> ${data.competencia}</p>`,
                `<p><strong>Niveles:</strong> ${data.levels.join(', ')}</p>`,
                `<table border="1" cellpadding="10" cellspacing="0" style="width:100%; border-collapse:collapse;">${tableHTML}</table>`
            ].join('');
            return wrapHTMLDocument('R√∫brica Anal√≠tica', body);
        }

        function copyRubricText() {
            if (!generatedInstruments.rubric) {
                alert('Primero genera la vista previa de la r√∫brica.');
                return;
            }
            copyTextToClipboard(buildRubricText(generatedInstruments.rubric), '‚úÖ R√∫brica copiada al portapapeles');
        }

        function exportRubricHTML() {
            if (!generatedInstruments.rubric) {
                alert('Primero genera la vista previa de la r√∫brica.');
                return;
            }
            downloadFile('rubrica-analitica.html', buildRubricHTML(generatedInstruments.rubric));
        }

        function generateChecklistAI() {
            const actividad = document.getElementById('checklistActividad').value.trim() || 'el producto';
            const base = actividad.toLowerCase();
            const suggestions = [
                `Entrega evidencia completa de ${base}`,
                `Cumple con las especificaciones t√©cnicas de ${base}`,
                `Presenta documentaci√≥n oportuna de ${base}`,
                `Demuestra manejo adecuado de recursos durante ${base}`,
                `Incluye criterios de seguridad y normatividad en ${base}`,
                `Mantiene orden y limpieza antes, durante y despu√©s de ${base}`,
                `Comunica resultados y hallazgos derivados de ${base}`,
                `Recibe retroalimentaci√≥n e incorpora mejoras al realizar ${base}`
            ];
            const list = document.getElementById('checklistItemsList');
            list.innerHTML = '';
            suggestions.forEach(text => createListItem('checklistItemsList', '√çtem verificable', text));
            alert('‚ú® Lista sugerida. Ajusta los √≠tems antes de generar la vista previa.');
        }

        function buildChecklistData() {
            const actividad = document.getElementById('checklistActividad').value.trim();
            const items = collectListValues('checklistItemsList');
            if (!actividad) {
                alert('Describe la actividad o producto que evaluar√°s.');
                return null;
            }
            if (items.length < 5) {
                alert('Agrega al menos 5 √≠tems para la lista de cotejo.');
                return null;
            }
            return { actividad, items };
        }

        function previewChecklist() {
            const data = buildChecklistData();
            if (!data) return;
            const table = document.getElementById('checklistTable');
            const header = '<tr><th>#</th><th>√çtem a verificar</th><th>Cumple (S√≠/No)</th><th>Observaciones</th></tr>';
            const body = data.items
                .map((item, index) => `<tr><td>${index + 1}</td><td>${item}</td><td>‚¨ú S√≠ / ‚¨ú No</td><td></td></tr>`)
                .join('');
            table.innerHTML = `<thead>${header}</thead><tbody>${body}</tbody>`;
            document.getElementById('checklistPreview').style.display = 'block';
            generatedInstruments.checklist = data;
            updateInstrumentStatus('checklist', true);
        }

        function buildChecklistText(data) {
            let text = `LISTA DE COTEJO\nActividad: ${data.actividad}`;
            data.items.forEach((item, index) => {
                text += `\n${index + 1}. ${item} [ ] S√≠  [ ] No`;
            });
            return text;
        }

        function buildChecklistHTML(data) {
            const header = '<tr><th>#</th><th>√çtem a verificar</th><th>Cumple (S√≠/No)</th><th>Observaciones</th></tr>';
            const body = data.items
                .map((item, index) => `<tr><td>${index + 1}</td><td>${item}</td><td>‚¨ú S√≠ / ‚¨ú No</td><td></td></tr>`)
                .join('');
            const table = `<table border="1" cellpadding="10" cellspacing="0" style="width:100%; border-collapse:collapse;"><thead>${header}</thead><tbody>${body}</tbody></table>`;
            const content = `<h1>Lista de Cotejo</h1><p><strong>Actividad:</strong> ${data.actividad}</p>${table}`;
            return wrapHTMLDocument('Lista de Cotejo', content);
        }

        function copyChecklistText() {
            if (!generatedInstruments.checklist) {
                alert('Primero genera la vista previa de la lista de cotejo.');
                return;
            }
            copyTextToClipboard(buildChecklistText(generatedInstruments.checklist), '‚úÖ Lista de cotejo copiada');
        }

        function exportChecklistHTML() {
            if (!generatedInstruments.checklist) {
                alert('Primero genera la vista previa de la lista de cotejo.');
                return;
            }
            downloadFile('lista-cotejo.html', buildChecklistHTML(generatedInstruments.checklist));
        }

        function generateMatrixAI() {
            const competencia = document.getElementById('matrixCompetencia').value.trim() || 'la competencia seleccionada';
            const criteriaSuggestions = [
                `Dominio conceptual de ${competencia.toLowerCase()}`,
                `Aplicaci√≥n procedimental en ${competencia.toLowerCase()}`,
                `Gesti√≥n de recursos y tiempos durante ${competencia.toLowerCase()}`,
                `Evidencia y documentaci√≥n de ${competencia.toLowerCase()}`
            ];
            const levelSuggestions = ['Cr√≠tico', 'B√°sico', 'Alto', 'Superior'];
            const criteriaList = document.getElementById('matrixCriteriaList');
            criteriaList.innerHTML = '';
            criteriaSuggestions.forEach(text => createListItem('matrixCriteriaList', 'Criterio de evaluaci√≥n', text));
            const levelsList = document.getElementById('matrixLevelsList');
            levelsList.innerHTML = '';
            levelSuggestions.forEach(text => createListItem('matrixLevelsList', 'Nivel de logro', text));
            alert('‚ú® Matriz sugerida. Ajusta criterios y niveles antes de obtener la vista previa.');
        }

        function buildMatrixData() {
            const competencia = document.getElementById('matrixCompetencia').value.trim();
            const criteria = collectListValues('matrixCriteriaList');
            const levels = collectListValues('matrixLevelsList');
            if (!competencia) {
                alert('Describe la competencia a evaluar en la matriz.');
                return null;
            }
            if (criteria.length < 3) {
                alert('Incluye al menos 3 criterios en la matriz.');
                return null;
            }
            if (levels.length < 3) {
                alert('Incluye al menos 3 niveles de desempe√±o.');
                return null;
            }
            const descriptors = criteria.map(criterion =>
                levels.map((level, index) => createMatrixDescriptor(criterion, level, index))
            );
            return { competencia, criteria, levels, descriptors };
        }

        function createMatrixDescriptor(criterion, level, index) {
            const nuances = [
                'requiere acompa√±amiento para cumplir el criterio',
                'demuestra avances parciales con apoyo puntual',
                'cumple con los est√°ndares establecidos',
                'supera las expectativas y aporta mejoras'
            ];
            const nuance = nuances[index] || nuances[nuances.length - 1];
            return `${level}: ${criterion.toLowerCase()} ${nuance}.`;
        }

        function previewMatrix() {
            const data = buildMatrixData();
            if (!data) return;
            const header = '<tr><th>Criterio</th>' + data.levels.map(level => `<th>${level}</th>`).join('') + '</tr>';
            const body = data.criteria
                .map((criterion, rowIndex) => {
                    const cells = data.descriptors[rowIndex].map(desc => `<td>${desc}</td>`).join('');
                    return `<tr><td>${criterion}</td>${cells}</tr>`;
                })
                .join('');
            document.getElementById('matrixTable').innerHTML = `<thead>${header}</thead><tbody>${body}</tbody>`;
            document.getElementById('matrixPreview').style.display = 'block';
            generatedInstruments.matrix = data;
            updateInstrumentStatus('matrix', true);
        }

        function buildMatrixText(data) {
            let text = `MATRIZ DE EVALUACI√ìN\nCompetencia: ${data.competencia}\nNiveles: ${data.levels.join(' | ')}`;
            data.criteria.forEach((criterion, index) => {
                text += `\n\n${criterion}`;
                data.levels.forEach((level, levelIndex) => {
                    text += `\n- ${level}: ${data.descriptors[index][levelIndex]}`;
                });
            });
            return text;
        }

        function buildMatrixHTML(data) {
            const header = '<tr><th>Criterio</th>' + data.levels.map(level => `<th>${level}</th>`).join('') + '</tr>';
            const body = data.criteria
                .map((criterion, rowIndex) => {
                    const cells = data.descriptors[rowIndex].map(desc => `<td>${desc}</td>`).join('');
                    return `<tr><td>${criterion}</td>${cells}</tr>`;
                })
                .join('');
            const table = `<table border="1" cellpadding="10" cellspacing="0" style="width:100%; border-collapse:collapse;"><thead>${header}</thead><tbody>${body}</tbody></table>`;
            const content = `<h1>Matriz de Evaluaci√≥n</h1><p><strong>Competencia:</strong> ${data.competencia}</p>${table}`;
            return wrapHTMLDocument('Matriz de Evaluaci√≥n', content);
        }

        function copyMatrixText() {
            if (!generatedInstruments.matrix) {
                alert('Primero genera la vista previa de la matriz.');
                return;
            }
            copyTextToClipboard(buildMatrixText(generatedInstruments.matrix), '‚úÖ Matriz copiada al portapapeles');
        }

        function exportMatrixHTML() {
            if (!generatedInstruments.matrix) {
                alert('Primero genera la vista previa de la matriz.');
                return;
            }
            downloadFile('matriz-evaluacion.html', buildMatrixHTML(generatedInstruments.matrix));
        }

        function wrapHTMLDocument(title, bodyContent) {
            const head = [
                '<!DOCTYPE html>',
                '<html lang="es">',
                '<head>',
                '<meta charset="UTF-8">',
                `<title>${title}</title>`,
                '<style>',
                'body{font-family:Inter,Arial,sans-serif;padding:2rem;background:#f8f9fb;color:#2d3436;}',
                'h1{color:#e67e22;}',
                'table{border-collapse:collapse;margin-top:1.5rem;width:100%;}',
                'th{background:#e67e22;color:#fff;}',
                'td,th{border:1px solid #ddd;padding:0.75rem;text-align:left;}',
                '</style>',
                '</head>',
                '<body>'
            ].join('');
            return `${head}${bodyContent}</body></html>`;
        }

        function copyTextToClipboard(text, successMessage) {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => {
                    alert(successMessage);
                });
            } else {
                const temp = document.createElement('textarea');
                temp.value = text;
                document.body.appendChild(temp);
                temp.select();
                document.execCommand('copy');
                document.body.removeChild(temp);
                alert(successMessage);
            }
        }

        function downloadFile(filename, content) {
            const blob = new Blob([content], { type: 'text/html;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            alert('üìÅ Archivo descargado correctamente');
        }

        function getSelectedInstruments() {
            return ['rubric', 'checklist', 'matrix']
                .filter(type => includeCheckboxes[type] && includeCheckboxes[type].checked && generatedInstruments[type]);
        }

        function copyCombinedToolkit() {
            const selected = getSelectedInstruments();
            if (selected.length === 0) {
                alert('Selecciona al menos un instrumento para copiar.');
                return;
            }
            const sections = selected.map(type => {
                if (type === 'rubric') return buildRubricText(generatedInstruments.rubric);
                if (type === 'checklist') return buildChecklistText(generatedInstruments.checklist);
                return buildMatrixText(generatedInstruments.matrix);
            });
            copyTextToClipboard(sections.join('\n\n==============================\n\n'), '‚úÖ Toolkit combinado copiado');
            generatedInstruments.bundleReady = true;
            updateToolkitReadiness();
        }

        function exportCombinedHTML() {
            const selected = getSelectedInstruments();
            if (selected.length === 0) {
                alert('Selecciona al menos un instrumento para exportar.');
                return;
            }
            const sections = selected
                .map(type => {
                    if (type === 'rubric') {
                        return `<section><h2>R√∫brica Anal√≠tica</h2>${generateRubricSectionHTML(generatedInstruments.rubric)}</section>`;
                    }
                    if (type === 'checklist') {
                        return `<section><h2>Lista de Cotejo</h2>${generateChecklistSectionHTML(generatedInstruments.checklist)}</section>`;
                    }
                    return `<section><h2>Matriz de Evaluaci√≥n</h2>${generateMatrixSectionHTML(generatedInstruments.matrix)}</section>`;
                })
                .join('');
            const head = [
                '<!DOCTYPE html>',
                '<html lang="es">',
                '<head>',
                '<meta charset="UTF-8">',
                '<title>Toolkit de Evaluaci√≥n</title>',
                '<style>',
                'body{font-family:Inter,Arial,sans-serif;padding:2rem;background:#f4f6fb;color:#1f2933;}',
                'h1{color:#e67e22;}',
                'h2{color:#764ba2;margin-top:2rem;}',
                'table{width:100%;border-collapse:collapse;margin-top:1rem;}',
                'th,td{border:1px solid #d1d5db;padding:0.75rem;text-align:left;}',
                'th{background:#e67e22;color:white;}',
                'section{margin-bottom:2rem;padding-bottom:2rem;border-bottom:2px solid #e5e7eb;}',
                '</style>',
                '</head>',
                '<body>',
                '<h1>Toolkit del Forjador</h1>'
            ].join('');
            const html = `${head}${sections}</body></html>`;
            downloadFile('toolkit-forjador.html', html);
            generatedInstruments.bundleReady = true;
            updateToolkitReadiness();
        }

        function generateRubricSectionHTML(data) {
            const table = generateRubricTableHTML(data);
            return `<p><strong>Competencia:</strong> ${data.competencia}</p><table>${table}</table>`;
        }

        function generateChecklistSectionHTML(data) {
            const header = '<tr><th>#</th><th>√çtem a verificar</th><th>Cumple</th><th>Observaciones</th></tr>';
            const body = data.items
                .map((item, index) => `<tr><td>${index + 1}</td><td>${item}</td><td>‚¨ú S√≠ / ‚¨ú No</td><td></td></tr>`)
                .join('');
            return `<p><strong>Actividad:</strong> ${data.actividad}</p><table><thead>${header}</thead><tbody>${body}</tbody></table>`;
        }

        function generateMatrixSectionHTML(data) {
            const header = '<tr><th>Criterio</th>' + data.levels.map(level => `<th>${level}</th>`).join('') + '</tr>';
            const body = data.criteria
                .map((criterion, rowIndex) => {
                    const cells = data.descriptors[rowIndex].map(desc => `<td>${desc}</td>`).join('');
                    return `<tr><td>${criterion}</td>${cells}</tr>`;
                })
                .join('');
            return `<p><strong>Competencia:</strong> ${data.competencia}</p><table><thead>${header}</thead><tbody>${body}</tbody></table>`;
        }

        function updateToolkitReadiness() {
            const toolkitStatus = document.getElementById('toolkitStatus');
            const bundleNotice = document.getElementById('bundleNotice');
            if (!toolkitStatus) return;
            const hasRubric = Boolean(generatedInstruments.rubric);
            const hasChecklist = Boolean(generatedInstruments.checklist);
            const hasMatrix = Boolean(generatedInstruments.matrix);
            const allReady = hasRubric && hasChecklist && hasMatrix;
            if (generatedInstruments.bundleReady && allReady) {
                toolkitStatus.textContent = 'Toolkit listo y exportado';
                toolkitStatus.classList.add('completed');
                if (bundleNotice) {
                    bundleNotice.textContent = 'Toolkit integrado listo para compartir o subir a tu LMS.';
                }
            } else if (allReady) {
                toolkitStatus.textContent = 'Genera la exportaci√≥n m√∫ltiple para finalizar';
                toolkitStatus.classList.remove('completed');
                if (bundleNotice) {
                    bundleNotice.textContent = 'Utiliza la exportaci√≥n m√∫ltiple para consolidar tus instrumentos.';
                }
            } else {
                toolkitStatus.textContent = 'Genera los tres instrumentos con IA';
                toolkitStatus.classList.remove('completed');
                if (bundleNotice) {
                    bundleNotice.textContent = 'A√∫n faltan instrumentos por construir antes de consolidar el toolkit.';
                }
            }
        }

        function finalizeToolkit() {
            if (localStorage.getItem('odisea-station7-completed') === 'true') {
                document.getElementById('successModal').classList.add('active');
                return;
            }
            const allReady = generatedInstruments.rubric && generatedInstruments.checklist && generatedInstruments.matrix;
            if (!allReady) {
                alert('Genera los tres instrumentos antes de marcar el toolkit como completado.');
                return;
            }
            if (!generatedInstruments.bundleReady) {
                alert('Utiliza la exportaci√≥n m√∫ltiple para consolidar tu toolkit antes de completarlo.');
                return;
            }
            document.getElementById('successModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('successModal').classList.remove('active');
        }

        function claimRewards() {
            localStorage.setItem('odisea-station7-completed', 'true');
            if (window.odiseaProgress) {
                window.odiseaProgress.completeStation(7);
                window.odiseaProgress.earnBadge(7);
            } else {
                const progress = JSON.parse(localStorage.getItem('odisea-progress') || '{"stations":{},"badges":{}}');
                progress.stations[7] = true;
                progress.badges[7] = true;
                localStorage.setItem('odisea-progress', JSON.stringify(progress));
            }
            closeModal();
            updateCompletionBadge();
            alert('üéâ Progreso registrado. ¬°Tu insignia ya es visible en el mapa!');
        }

        document.getElementById('successModal').addEventListener('click', event => {
            if (event.target.id === 'successModal') {
                closeModal();
            }
        });

        function updateCompletionBadge() {
            const completed = localStorage.getItem('odisea-station7-completed') === 'true';
            const header = document.querySelector('.station-header');
            let badge = document.getElementById('station7Completion');
            if (completed && header) {
                if (!badge) {
                    badge = document.createElement('div');
                    badge.id = 'station7Completion';
                    badge.style.cssText = 'display:inline-block;padding:0.5rem 1rem;background:var(--success);color:white;border-radius:20px;font-size:0.9rem;margin-top:1rem;';
                    badge.innerHTML = '<i class="bi bi-check-circle-fill"></i> Ya completaste esta estaci√≥n';
                    header.appendChild(badge);
                }
                const toolkitStatus = document.getElementById('toolkitStatus');
                if (toolkitStatus) {
                    toolkitStatus.textContent = 'Toolkit entregado';
                    toolkitStatus.classList.add('completed');
                }
            }
        }

        updateInstrumentStatus('rubric', false);
        updateInstrumentStatus('checklist', false);
        updateInstrumentStatus('matrix', false);
        updateToolkitReadiness();
        updateCompletionBadge();
    </script>

</body>
</html>
